version: '3.8'

services:

    amqp:
        build:
            context: .
            dockerfile: ./amqp/Dockerfile
        expose:
            - "5672"
        restart: always
        env_file:
            - ../../.env.local
        volumes:
            - ../volumes/amqp:/var/lib/rabbitmq

    cache:
        image: redis
        command: redis-server --appendonly yes
        expose:
            - "6379"
        restart: always
        volumes:
            - ../volumes/cache:/data

    db_read:
        build: ./mysql
        restart: always
        env_file:
            - ../../.env.local
        ports:
            - "127.0.0.1:33062:3306"
        volumes:
            - ../volumes/db_read:/var/lib/mysql

    db_write:
        build: ./mariadb
        restart: always
        ports:
            - "127.0.0.1:33061:3306"
        env_file:
            - ../../.env.local
        volumes:
            - ../volumes/db_write:/var/lib/mysql
            - ./db_write/templates/docker.cnf:/etc/mysql/mariadb.conf.d/docker.cnf

    web:
        build: ./apache
        networks:
            - press-review-network
        ports:
            - "127.0.0.1:80:80"
        volumes:
            - ../containers/apache/templates:/templates
            - ../containers/apache/tasks:/tasks
            - ../../:/var/www/revue-de-presse.org
        external_links:
            - mysql
        depends_on:
            - cache
            - worker

    web-worker:
        build:
            context: .
            dockerfile: ./service/Dockerfile
        restart: always
        volumes:
            - "./php-fpm/templates/extensions.ini.dist:/usr/local/etc/php/conf.d/extensions.ini"
            - "./php-fpm/templates/docker.conf:/usr/local/etc/php-fpm.d/docker.conf"
            - "./php-fpm/templates/empty.conf:/usr/local/etc/php-fpm.d/zz-docker.conf"
            - "./php-fpm/templates/www.conf:/usr/local/etc/php-fpm.d/www.conf"
            - "../../:/var/www/revue-de-presse.org"
        env_file:
            - ../../.env.local
        depends_on:
            - cache

    worker:
        build:
            context: .
            dockerfile: ./worker/Dockerfile
        volumes:
            - ../../:/var/www/revue-de-presse.org
        depends_on:
            - amqp
